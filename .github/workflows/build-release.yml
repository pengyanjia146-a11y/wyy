name: Build Debug APK (Auto Version)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Dependencies
        run: npm install

      # 1. ä¿®å¤ TS é…ç½®å¹¶æ„å»ºç½‘é¡µ (å…³é—­ä¸¥æ ¼æ¨¡å¼)
      - name: Fix TS Config & Build
        run: |
          echo '{
            "compilerOptions": {
              "target": "ES2020",
              "useDefineForClassFields": true,
              "lib": ["ES2020", "DOM", "DOM.Iterable"],
              "module": "ESNext",
              "skipLibCheck": true,
              "moduleResolution": "bundler",
              "allowImportingTsExtensions": true,
              "resolveJsonModule": true,
              "isolatedModules": true,
              "noEmit": true,
              "jsx": "react-jsx",
              "strict": false,            
              "noImplicitAny": false,     
              "noUnusedLocals": false,
              "noUnusedParameters": false,
              "noFallthroughCasesInSwitch": true
            },
            "include": ["."], 
            "exclude": ["node_modules", "dist", "android", "vite.config.ts", "server.js"]
          }' > tsconfig.json
          
          # å¼€å§‹æ„å»º dist
          npm run build

      # 2. åˆå§‹åŒ– Capacitor å®‰å“ç¯å¢ƒ
      - name: Setup Capacitor
        run: |
          npm install @capacitor/core @capacitor/cli @capacitor/android
          
          # å¦‚æœæ²¡æœ‰ android ç›®å½•åˆ™è‡ªåŠ¨åˆ›å»º
          if [ ! -d "android" ]; then
            echo "Android folder not found. Creating..."
            npx cap add android
          fi
          
          # åŒæ­¥èµ„æº
          npx cap copy android
          npx cap sync android

      # ğŸŸ¢ 3. æ ¸å¿ƒæ­¥éª¤ï¼šä¿®æ”¹ç‰ˆæœ¬å·
      # å°† versionCode ä¿®æ”¹ä¸º GitHub çš„ run_number (å¦‚ 45)
      # å°† versionName ä¿®æ”¹ä¸º 1.0.0.45
      - name: Bump Android Version
        run: |
          echo "ğŸš€ Bump version to 1.0.0.${{ github.run_number }}"
          cd android/app
          
          # ä½¿ç”¨ sed å‘½ä»¤ç›´æ¥ä¿®æ”¹ build.gradle æ–‡ä»¶
          sed -i 's/versionCode [0-9]\+/versionCode ${{ github.run_number }}/g' build.gradle
          sed -i 's/versionName "[^"]*"/versionName "1.0.0.${{ github.run_number }}"/g' build.gradle
          
          # æ‰“å°æ£€æŸ¥
          grep "versionCode" build.gradle
          grep "versionName" build.gradle

      # 4. æ„å»º Debug åŒ… (è‡ªå¸¦ç­¾åï¼Œå¯ç›´æ¥å®‰è£…)
      - name: Build Debug APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug

      # 5. ä¸Šä¼ äº§ç‰©
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          # æ–‡ä»¶åå¸¦ä¸Šç‰ˆæœ¬å·ï¼Œæ–¹ä¾¿åŒºåˆ†
          name: UniStream-v1.0.0.${{ github.run_number }}
          path: android/app/build/outputs/apk/debug/*.apk
